# 실행 흐름 비교: "두 번의 대화" 방식 vs "한 번의 위임" 방식

## 이전 코드의 실행 흐름: "두 번의 대화" 방식

### 처리 흐름

1. **Controller**: 사용자의 수정 요청(PUT /carts/5)을 받는다.
2. **Service**:
   - **1차 DB 통신 (조회)**:
     - 데이터베이스에 요청: "id가 5인 장바구니 상품 정보를 가져와."
     - `cartRepository.findCartItemById(5)` 호출 → SQL: `SELECT * FROM carts WHERE id = 5;`
   - **소유권 판단**:
     - Node.js 애플리케이션이 받아온 데이터를 확인하여 `item.user_id`와 현재 로그인한 사용자의 `userId`를 비교.
     - `if (item.user_id !== userId)`
   - **2차 DB 통신 (수정)**:
     - 소유권이 확인되면, 데이터베이스에 요청: "id가 5인 상품의 수량을 3으로 수정해줘."
     - `cartRepository.updateCartItemQuantity(5, 3)` 호출 → SQL: `UPDATE carts SET quantity = 3 WHERE id = 5;`

### 문제점

1. **두 번의 DB 통신**:
   - 조회(SELECT)와 수정(UPDATE)을 위해 데이터베이스와 최소 두 번 통신해야 하므로 비효율적이다.
2. **레이스 컨디션 가능성**:
   - 조회(SELECT)와 수정(UPDATE) 사이에 다른 요청으로 인해 데이터가 변경될 경우, 의도치 않은 결과가 발생할 수 있다.
   - 예: 조회 후 삭제된 상품을 수정하려는 경우.

---

## 개선된 코드의 실행 흐름: "한 번의 위임" 방식

### 처리 흐름

1. **Controller**:
   - **입력값 사전 검증**:
     - 요청을 받자마자 `quantity`가 1 이상인지 등 유효성 검사를 수행.
     - 유효하지 않으면 즉시 `400 Bad Request` 에러를 반환하고, 더 이상 진행하지 않음.
2. **Service**:
   - **단일 DB 통신 (조건부 수정)**:
     - 데이터베이스에 요청: "id가 5이고, 동시에 `user_id`가 현재 로그인한 사용자와 일치하는 상품이 있으면, 그 상품의 수량을 3으로 수정하고, 몇 개가 바뀌었는지 알려줘."
     - `cartRepository.updateCartItemQuantity(5, 3, userId)` 호출 → SQL: `UPDATE carts SET quantity = 3 WHERE id = 5 AND user_id = {현재_사용자_ID};`
   - **결과 확인**:
     - 데이터베이스에서 작업 결과(변경된 행의 수, `affectedRows`)를 전달받아 처리.
     - `if (affectedRows === 0)`:
       - 변경된 행이 없으면, 상품이 없거나 권한이 없음을 의미.
       - "상품을 찾을 수 없거나 권한이 없음" 에러 발생.
     - `if (affectedRows > 0)`:
       - 변경된 행이 1개 이상이면 작업 성공.

### 개선점

1. **효율성**:
   - 데이터베이스와의 통신이 단 한 번으로 줄어들어 성능이 향상됨.
2. **안전성 (원자성)**:
   - 소유권 확인과 데이터 수정이 하나의 SQL 쿼리로 원자적(atomic)으로 수행되어, 중간에 데이터가 변경될 위험이 사라짐.
3. **신뢰성**:
   - 컨트롤러 단계에서 입력값을 미리 검증하여 비정상적인 데이터로 인한 서버 오류를 방지.
4. **코드 간결성**:
   - 서비스 계층에서 불필요한 SELECT 로직이 사라져 코드가 단순하고 명확해짐.

---

## 핵심 비교

| 구분             | 이전 방식                    | 개선된 방식                     |
| ---------------- | ---------------------------- | ------------------------------- |
| **판단 주체**    | 애플리케이션                 | 데이터베이스 (SQL WHERE 절)     |
| **DB 통신 횟수** | 2회 (SELECT → UPDATE/DELETE) | 1회 (조건부 UPDATE/DELETE)      |
| **실행 흐름**    | 조회 → 코드 내 비교 → 수정   | 한 번에 조건부 수정 → 결과 확인 |
| **안정성**       | 낮음 (레이스 컨디션 가능성)  | 높음 (원자적 연산)              |
| **입력값 검증**  | 없음                         | 컨트롤러에서 선제적으로 수행    |
